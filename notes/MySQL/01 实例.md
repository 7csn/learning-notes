# 01 实例

### 数据库架构
master x 1 -> slave x 15  

问题：从服务器多，主从切换，同步数据，耗时半小时；主服务器网卡容量挑战性大。

### 配置
CPU：64核

内存：512GB

### 监控信息（主服务器）
| 类型 | 范围 | 平均 |
| - | :-: | -: |
| QPS | 4.2 - 37.5 | 20w |
| TPS | < 9.2 | 2w |
| 并发量 | 350 - 750 | 500 |
| CPU 空闲 | < 100 | 80% |
| 磁盘 IO 读 | < 540 | 10 |
| 磁盘 IO 写 | < 205 | 40 |

注：不要在主库备份，大型活动前取消这类计划

影响数据库的因素：SQL查询速度、服务器硬件、网卡流量、磁盘IO

### 超高的 QPS 和 TPS
SQL慢查询要解决，不支持多CPU并发运算

### 大量并发
数据库连接数被占满（max_connections默认100）

### 超高CPU使用率
因CPU资源耗尽而宕机

### 磁盘IO
性能突然下降（使用更快磁盘设备）
其他大量消耗磁盘性能的计划任务（调整计划任务，做好磁盘维护）

### 网卡流量
网卡IO被占满（1000M => 125M)
1. 减少从服务器数量
2. 进行分级缓存
3. 精确查询
4. 分离业务网络和服务器网络

### 大表（相对而言）
记录行数巨大，超过千万行；数据文件巨大，超过10G

风险：
1. 慢查询

    来源少，区分度低，大量磁盘IO，降低磁盘效率

2. 建立索引耗时长

    版本 < 5.5 锁表；>= 5.5 主从延迟
    
3. 对DDL操作

    长时间主从延迟，影响正常数据操作
    
处理：
1. 分库分表（大量人力物力，影响后端业务）

    难点：
    * 分表主键选择
    * 分表后跨分区数据的查询和统计
    
2. 大表历史数据归档

    减少前后端业务的影响
    
    难点：
    * 归档时间的选择
    * 如何进行归档操作

### 大事务
运行时长，操作数据多

事务特性：
* 原子性：整体成败，不可分割  
* 一致性：事务前后状态由一个一致性到另一个一致性
* 隔离性：未提交数据对其他事务不可见，同事务同查询一致
* 持久性：提交对数据库修改是持久的

隔离级别：未提交读、已提交读、可重复读、可串行化

风险：
1. 锁定太多数据，造成大量阻塞和锁超时
2. 回滚耗时较长
3. 执行时间长，容易造成主从延迟

解决：
1. 避免一次处理太多数据
2. 移出不必要在事务中的select操作
